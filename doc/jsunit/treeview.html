<!DOCTYPE html>
<html lang="zh-cn">
<head>
<!-- 该文档由doc-src自动生成 -->
<meta charset="utf-8">
<title>Regular UI</title>
<meta name="author" content="森森">
<meta name="keywords" content="Regular,UI,JavaScript,Framework,MVC,MVVM">
<meta name="description" content="Regular UI">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<link rel="icon" href="/global/img/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" href="/global/img/favicon.ico" type="image/x-icon">
<link rel="stylesheet" id="j-themeCSS">
<script>
// 该段代码是选择主题用的，与渲染有关，所以必须放前面。
var relativePath = '../';
var themes = [
    {id: 1, name: 'default'},
    {id: 2, name: 'flat'},
    {id: 3, name: 'bootstrap'}
];

var selectedTheme;
if(localStorage['selectedTheme']) {
    for(var i = 0; i < themes.length; i++)
        if(themes[i].name === localStorage['selectedTheme']) {
            selectedTheme = themes[i];
            break;
        }
} else {
    selectedTheme = themes[0];
}

var themeCSS = document.getElementById('j-themeCSS');
themeCSS.href = window.relativePath + 'css/' + selectedTheme.name + '.css';
</script>
<body>
<div class="g-top">
    <div class="g-topc">
        <h1 class="m-logo">
            <a href="/">Regular UI</a>
        </h1>
        <ul class="m-nav f-fr">
            
            
            <li><a href="../start/index.html">开始使用</a></li>
            
            
            <li><a href="../cssunit/index.html">CSS元件</a></li>
            
            
            <li><a href="../cssmodule/index.html">CSS模块</a></li>
            
            
            <li class="z-crt"><a href="../jsunit/index.html">JS元件</a></li>
            
            
            <li><a href="../jsmodule/index.html">JS模块</a></li>
            
            <li id="j-themeSelectEx"></li>
        </ul>
    </div>
</div>
<div class="g-bd">
    <div class="g-bdc"><div class="g-sd">
    <ul class="m-sidebar">
        
        
        
        
        
        <li class="sidebar_group"><span>消息类</span></li>
        
        <li><a href="../jsunit/notify.html">通知<small> Notify</small>
        
            <i class="u-icon u-icon-success-circle" title="功能和主题全部实现，文档比较完善"></i>
        
        </a></li>
        
        
        
        <li><a href="../jsunit/progress.html">进度条<small> Progress</small>
        
            <i class="u-icon u-icon-success-circle" title="功能和主题全部实现，文档比较完善"></i>
        
        </a></li>
        
        
        
        <li class="sidebar_group"><span>导航类</span></li>
        
        <li><a href="../jsunit/dropdown.html">下拉菜单<small> DropDown</small>
        
        </a></li>
        
        
        
        <li><a href="../jsunit/menu.html">多级菜单<small> Menu</small>
        
        </a></li>
        
        
        
        <li class="sidebar_group"><span>数据类</span></li>
        
        <li><a href="../jsunit/listbox.html">列表框<small> ListBox</small>
        
            <i class="u-icon u-icon-success-circle" title="功能和主题全部实现，文档比较完善"></i>
        
        </a></li>
        
        
        
        
        <li><a href="../jsunit/listview.html">列表视图<small> ListView</small>
        
            <i class="u-icon u-icon-success-circle" title="功能和主题全部实现，文档比较完善"></i>
        
        </a></li>
        
        
        
        <li><a href="../jsunit/gridview.html">网格视图<small> GridView</small>
        
            <i class="u-icon u-icon-info-circle" title="功能和主题部分实现，文档有待完善"></i>
        
        </a></li>
        
        
        
        <li class="z-crt"><a href="../jsunit/treeview.html">树型视图<small> TreeView</small>
        
            <i class="u-icon u-icon-success-circle" title="功能和主题全部实现，文档比较完善"></i>
        
        </a></li>
        
        
        
        <li><a href="../jsunit/tableview.html">表格视图<small> TableView</small>
        
            <i class="u-icon u-icon-info-circle" title="功能和主题部分实现，文档有待完善"></i>
        
        </a></li>
        
        
        
        <li class="sidebar_group"><span>表单类</span></li>
        
        <li><a href="../jsunit/inputex.html">输入扩展<small> InputEx</small>
        
        </a></li>
        
        
        
        <li><a href="../jsunit/checkex.html">多选按钮<small> CheckEx</small>
        
            <i class="u-icon u-icon-success-circle" title="功能和主题全部实现，文档比较完善"></i>
        
        </a></li>
        
        
        
        <li><a href="../jsunit/checkgroup.html">多选组<small> CheckGroup</small>
        
            <i class="u-icon u-icon-success-circle" title="功能和主题全部实现，文档比较完善"></i>
        
        </a></li>
        
        
        
        <li><a href="../jsunit/radiogroup.html">单选组<small> RadioGroup</small>
        
            <i class="u-icon u-icon-success-circle" title="功能和主题全部实现，文档比较完善"></i>
        
        </a></li>
        
        
        
        <li><a href="../jsunit/selectex.html">选择扩展<small> SelectEx</small>
        
            <i class="u-icon u-icon-success-circle" title="功能和主题全部实现，文档比较完善"></i>
        
        </a></li>
        
        
        
        <li><a href="../jsunit/treeselect.html">树型选择<small> TreeSelect</small>
        
            <i class="u-icon u-icon-success-circle" title="功能和主题全部实现，文档比较完善"></i>
        
        </a></li>
        
        
        
        <li><a href="../jsunit/suggest.html">自动提示<small> Suggest</small>
        
            <i class="u-icon u-icon-info-circle" title="功能和主题部分实现，文档有待完善"></i>
        
        </a></li>
        
        
        
        
        
        
        
        <li class="sidebar_group"><span>日期类</span></li>
        
        <li><a href="../jsunit/calendar.html">日历<small> Calendar</small>
        
            <i class="u-icon u-icon-success-circle" title="功能和主题全部实现，文档比较完善"></i>
        
        </a></li>
        
        
        
        <li><a href="../jsunit/datepicker.html">日期选择<small> DatePicker</small>
        
            <i class="u-icon u-icon-info-circle" title="功能和主题部分实现，文档有待完善"></i>
        
        </a></li>
        
        
        
        <li><a href="../jsunit/timepicker.html">时间选择<small> TimePicker</small>
        
        </a></li>
        
        
        
        <li><a href="../jsunit/datetimepicker.html">日期时间选择<small> DateTimePicker</small>
        
        </a></li>
        
        
        
        
        
        <li class="sidebar_group"><span>效果类</span></li>
        
        <li><a href="../jsunit/dragdrop.html">拖拽<small> DragDrop</small>
        
        </a></li>
        
        
    </ul>
</div><div class="g-mn">
    <article class="m-article">
        
        <h2>树型视图<small> TreeView</small></h2>
        
        <h3 id="-">示例</h3>
<h4 id="-">基本形式</h4>
<div id="j-example1"></div>

<pre class="lang-xml"><code><span class="cm-tagcm-bracket">&lt;</span><span class="cm-tag">treeView</span> <span class="cm-attribute">source</span>=<span class="cm-attribute">{source}</span> <span class="cm-tagcm-bracketcm-error">/&gt;</span>
</code></pre>
<p>或</p>
<pre class="lang-javascript"><code><span class="cm-keyword">var</span> <span class="cm-variable">source</span> <span class="cm-operator">=</span> [
    {<span class="cm-property">id</span>: <span class="cm-number">1</span>, <span class="cm-property">name</span>: <span class="cm-string">&#39;节点1&#39;</span>, <span class="cm-property">children</span>: [
        {<span class="cm-property">id</span>: <span class="cm-number">11</span>, <span class="cm-property">name</span>: <span class="cm-string">&#39;节点1.1&#39;</span>},
        {<span class="cm-property">id</span>: <span class="cm-number">12</span>, <span class="cm-property">name</span>: <span class="cm-string">&#39;节点1.2&#39;</span>, <span class="cm-property">children</span>: [
            {<span class="cm-property">id</span>: <span class="cm-number">101</span>, <span class="cm-property">name</span>: <span class="cm-string">&#39;节点1.2.1&#39;</span>},
            {<span class="cm-property">id</span>: <span class="cm-number">102</span>, <span class="cm-property">name</span>: <span class="cm-string">&#39;节点1.2.2&#39;</span>}
        ]},
        {<span class="cm-property">id</span>: <span class="cm-number">13</span>, <span class="cm-property">name</span>: <span class="cm-string">&#39;节点1.3&#39;</span>},
        {<span class="cm-property">id</span>: <span class="cm-number">14</span>, <span class="cm-property">name</span>: <span class="cm-string">&#39;节点1.4&#39;</span>},
    ]},
    {<span class="cm-variable">id</span>: <span class="cm-number">2</span>, <span class="cm-variable">name</span>: <span class="cm-string">&#39;节点2&#39;</span>},
    {<span class="cm-variable">id</span>: <span class="cm-number">3</span>, <span class="cm-variable">name</span>: <span class="cm-string">&#39;节点3&#39;</span>, <span class="cm-variable">children</span>: [
        {<span class="cm-variable">id</span>: <span class="cm-number">15</span>, <span class="cm-variable">name</span>: <span class="cm-string">&#39;节点3.1&#39;</span>},
        {<span class="cm-variable">id</span>: <span class="cm-number">16</span>, <span class="cm-variable">name</span>: <span class="cm-string">&#39;节点3.2&#39;</span>}
    ]}
];

<span class="cm-keyword">var</span> <span class="cm-variable">treeView</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">TreeView</span>({
    <span class="cm-property">data</span>: {
        <span class="cm-property">source</span>: <span class="cm-variable">source</span>
    }
}).<span class="cm-property">$inject</span>(<span class="cm-string">&#39;#j-example1&#39;</span>);
</code></pre>
<h4 id="-">禁用</h4>
<div id="j-example2"></div>

<pre class="lang-xml"><code><span class="cm-tagcm-bracket">&lt;</span><span class="cm-tag">treeView</span> <span class="cm-attribute">source</span>=<span class="cm-attribute">{source}</span> <span class="cm-attribute">disabled</span>=<span class="cm-attribute">{true}</span> <span class="cm-tagcm-bracketcm-error">/&gt;</span>
</code></pre>
<p>或</p>
<pre class="lang-javascript"><code><span class="cm-keyword">var</span> <span class="cm-variable">treeView</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">TreeView</span>({
    <span class="cm-property">data</span>: {
        <span class="cm-property">source</span>: <span class="cm-variable">source</span>,
        <span class="cm-property">disabled</span>: <span class="cm-atom">true</span>
    }
}).<span class="cm-property">$inject</span>(<span class="cm-string">&#39;#j-example2&#39;</span>);
</code></pre>
<h4 id="-">远程数据</h4>
<div id="j-example3"></div>

<pre class="lang-xml"><code><span class="cm-tagcm-bracket">&lt;</span><span class="cm-tag">treeView</span> <span class="cm-attribute">service</span>=<span class="cm-attribute">{@(service)}</span> <span class="cm-tagcm-bracketcm-error">/&gt;</span>
</code></pre>
<p>或</p>
<pre class="lang-javascript"><code><span class="cm-keyword">var</span> <span class="cm-variable">service</span> <span class="cm-operator">=</span> {
    <span class="cm-property">getList</span>: <span class="cm-keyword">function</span>(<span class="cm-def">params</span>, <span class="cm-def">callback</span>) {
        <span class="cm-variable">ajax</span>.<span class="cm-property">request</span>({
            <span class="cm-property">url</span>: <span class="cm-string">&#39;treeview.json&#39;</span>,
            <span class="cm-property">method</span>: <span class="cm-string">&#39;get&#39;</span>,
            <span class="cm-property">type</span>: <span class="cm-string">&#39;json&#39;</span>,
            <span class="cm-property">success</span>: <span class="cm-keyword">function</span>(<span class="cm-def">data</span>) {
                <span class="cm-variable-2">callback</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable-2">callback</span>(<span class="cm-variable-2">data</span>);
            }
        });
    }
};

<span class="cm-keyword">var</span> <span class="cm-variable">treeView</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">TreeView</span>({
    <span class="cm-property">service</span>: <span class="cm-variable">service</span>
}).<span class="cm-property">$inject</span>(<span class="cm-string">&#39;#j-example3&#39;</span>);
</code></pre>
<h4 id="-">分级加载</h4>
<div id="j-example4"></div>

<pre class="lang-xml"><code><span class="cm-tagcm-bracket">&lt;</span><span class="cm-tag">treeView</span> <span class="cm-attribute">service</span>=<span class="cm-attribute">{@(service)}</span> <span class="cm-attribute">hierarchical</span>=<span class="cm-attribute">{true}</span> <span class="cm-tagcm-bracketcm-error">/&gt;</span>
</code></pre>
<p>或</p>
<pre class="lang-javascript"><code><span class="cm-keyword">var</span> <span class="cm-variable">service</span> <span class="cm-operator">=</span> {
    <span class="cm-property">getList</span>: <span class="cm-keyword">function</span>(<span class="cm-def">params</span>, <span class="cm-def">callback</span>) {
        <span class="cm-variable">ajax</span>.<span class="cm-property">request</span>({
            <span class="cm-property">url</span>: <span class="cm-string">&#39;treeview2.json&#39;</span>,
            <span class="cm-property">method</span>: <span class="cm-string">&#39;get&#39;</span>,
            <span class="cm-property">type</span>: <span class="cm-string">&#39;json&#39;</span>,
            <span class="cm-property">success</span>: <span class="cm-keyword">function</span>(<span class="cm-def">data</span>) {
                <span class="cm-variable-2">callback</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable-2">callback</span>(<span class="cm-variable-2">data</span>);
            }
        });
    }
};

<span class="cm-keyword">var</span> <span class="cm-variable">treeView</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">TreeView</span>({
    <span class="cm-property">service</span>: <span class="cm-variable">service</span>,
    <span class="cm-property">data</span>: {
        <span class="cm-property">hierarchical</span>: <span class="cm-atom">true</span>
    }
}).<span class="cm-property">$inject</span>(<span class="cm-string">&#39;#j-example4&#39;</span>);
</code></pre>
<h4 id="-">自定义选择项</h4>
<div id="j-example5"></div>

<pre class="lang-xml"><code><span class="cm-tagcm-bracket">&lt;</span><span class="cm-tag">treeView</span> <span class="cm-attribute">service</span>=<span class="cm-attribute">{@(service)}</span> <span class="cm-attribute">hierarchical</span>=<span class="cm-attribute">{true}</span> <span class="cm-attribute">itemTemplate</span>=<span class="cm-attribute">{@(itemTemplate)}</span> <span class="cm-tagcm-bracketcm-error">/&gt;</span>
</code></pre>
<p>或</p>
<pre class="lang-javascript"><code><span class="cm-keyword">var</span> <span class="cm-variable">itemTemplate</span> <span class="cm-operator">=</span> <span class="cm-variable">_</span>.<span class="cm-property">multiline</span>(<span class="cm-keyword">function</span>(){<span class="cm-comment">/*    </span>
<span class="cm-comment">&lt;i class=&quot;u-icon {item.type === &#39;directory&#39; ? (item.open ? &#39;u-icon-folder-open&#39; : &#39;u-icon-folder&#39;) : &#39;u-icon-file-text&#39;}&quot;&gt;&lt;/i&gt; {item.name}</span>
<span class="cm-comment">*/</span>});

<span class="cm-keyword">var</span> <span class="cm-variable">service</span> <span class="cm-operator">=</span> {
    <span class="cm-property">getList</span>: <span class="cm-keyword">function</span>(<span class="cm-def">params</span>, <span class="cm-def">callback</span>) {
        <span class="cm-variable">ajax</span>.<span class="cm-property">request</span>({
            <span class="cm-property">url</span>: <span class="cm-string">&#39;treeview2.json&#39;</span>,
            <span class="cm-property">method</span>: <span class="cm-string">&#39;get&#39;</span>,
            <span class="cm-property">type</span>: <span class="cm-string">&#39;json&#39;</span>,
            <span class="cm-property">success</span>: <span class="cm-keyword">function</span>(<span class="cm-def">data</span>) {
                <span class="cm-variable-2">callback</span> <span class="cm-operator">&amp;&amp;</span> <span class="cm-variable-2">callback</span>(<span class="cm-variable-2">data</span>);
            }
        });
    }
};
<span class="cm-keyword">var</span> <span class="cm-variable">treeView</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">TreeView</span>({
    <span class="cm-property">service</span>: <span class="cm-variable">service</span>,
    <span class="cm-property">data</span>: {
        <span class="cm-property">hierarchical</span>: <span class="cm-atom">true</span>,
        <span class="cm-property">itemTemplate</span>: <span class="cm-variable">itemTemplate</span>
    }
}).<span class="cm-property">$inject</span>(<span class="cm-string">&#39;#j-example5&#39;</span>);
</code></pre>
<h4 id="-">拖拽</h4>
<div id="j-example6"></div>
        <h3>API</h3>

<h4>Class</h4>
<h5>TreeView</h5>
<p>继承自<strong>SourceComponent</strong>。</p>
<p></p>
<div id="j-class"></div>

<h4>Options</h4>
<h5>new TreeView({options})</h5>
<table>
    <thead>
        <tr><th>参数</th><th>类型</th><th>默认值</th><th>描述</th></tr>
    </thead>
    <tbody>
        
        <tr><td class="f-wsn"><code>data</code></td><td class="f-wsn">object</td><td class="f-wsn"></td><td>绑定属性</td></tr>
        
        <tr><td class="f-wsn"><code>data.source</code></td><td class="f-wsn">object[]</td><td class="f-wsn"><code>[]</code></td><td>数据源</td></tr>
        
        <tr><td class="f-wsn"><code>data.source[].id</code></td><td class="f-wsn">number</td><td class="f-wsn"></td><td>每项的id</td></tr>
        
        <tr><td class="f-wsn"><code>data.source[].name</code></td><td class="f-wsn">string</td><td class="f-wsn"></td><td>每项的内容</td></tr>
        
        <tr><td class="f-wsn"><code>data.selected</code></td><td class="f-wsn">object</td><td class="f-wsn"><code>null</code></td><td>当前选择项</td></tr>
        
        <tr><td class="f-wsn"><code>data.disabled</code></td><td class="f-wsn">boolean</td><td class="f-wsn"><code>false</code></td><td>是否禁用该组件</td></tr>
        
        <tr><td class="f-wsn"><code>data.hierarchical</code></td><td class="f-wsn">boolean</td><td class="f-wsn"><code>false</code></td><td>是否分级动态加载，需要service</td></tr>
        
        <tr><td class="f-wsn"><code>data.class</code></td><td class="f-wsn">string</td><td class="f-wsn"><code>&#39;&#39;</code></td><td>补充class</td></tr>
        
        <tr><td class="f-wsn"><code>service</code></td><td class="f-wsn">object</td><td class="f-wsn"></td><td>数据服务</td></tr>
        
    </tbody>
</table>
<div id="j-options"></div>


<h4>Methods</h4>

<h5>treeView.select(item)</h5>
<p>选择某一项</p>
<table>
    <thead>
        <tr><th>参数</th><th>类型</th><th>默认值</th><th>描述</th></tr>
    </thead>
    <tbody>
        
        <tr><td class="f-wsn"><code>item</code></td><td class="f-wsn">object</td><td class="f-wsn"></td><td>选择项</td></tr>
        
    </tbody>
</table>


<div id="j-methods"></div>


<div id="j-staticMethods"></div>


<h4>Events</h4>

<h5>on-select={$event}</h5>
<p>选择某一项时触发</p>
<table>
    <thead>
        <tr><th>属性</th><th>类型</th><th>描述</th></tr>
    </thead>
    <tbody>
        
        <tr><td class="f-wsn"><code>selected</code></td><td class="f-wsn">object</td><td class="f-wsn">当前选择项</td></tr>
        
    </tbody>
</table>

<h5>on-toggle={$event}</h5>
<p>展开或收起某一项时触发</p>
<table>
    <thead>
        <tr><th>属性</th><th>类型</th><th>描述</th></tr>
    </thead>
    <tbody>
        
        <tr><td class="f-wsn"><code>item</code></td><td class="f-wsn">object</td><td class="f-wsn">展开收起项</td></tr>
        
        <tr><td class="f-wsn"><code>open</code></td><td class="f-wsn">boolean</td><td class="f-wsn">展开还是收起</td></tr>
        
    </tbody>
</table>


<div id="j-events"></div>
    </article>
</div>    </div>
</div>
<footer class="g-ft">
</footer>
<a href="#" class="m-gotop"></a>
<script src="../js/regular-ui.js"></script>
<script>
var themeSelectEx = new RGUI.SelectEx({
    data: {
        source: themes,
        selected: selectedTheme,
        placeholder: null,
        'class': 'u-selectex-nav'
    }
}).$inject('#j-themeSelectEx')
  .$on('select', function($event) {
    themeCSS.href = window.relativePath + 'css/' + $event.selected.name + '.css';
    localStorage['selectedTheme'] = $event.selected.name;
});
</script>
<script>
var TreeView = RGUI.TreeView;
var Regular = RGUI.Regular;
var ajax = RGUI.request;
var _ = RGUI._;

var source = [
    {id: 1, name: '节点1', children: [
        {id: 11, name: '节点1.1'},
        {id: 12, name: '节点1.2', children: [
            {id: 101, name: '节点1.2.1'},
            {id: 102, name: '节点1.2.2'}
        ]},
        {id: 13, name: '节点1.3'},
        {id: 14, name: '节点1.4'},
    ]},
    {id: 2, name: '节点2'},
    {id: 3, name: '节点3', children: [
        {id: 15, name: '节点3.1'},
        {id: 16, name: '节点3.2'}
    ]}
];

// 基本形式
(function() {
    var treeView = new TreeView({
        data: {
            source: source
        }
    }).$inject('#j-example1');
})();

// 禁用
(function() {
    var treeView = new TreeView({
        data: {
            source: source,
            disabled: true
        }
    }).$inject('#j-example2');
})();

// 远程数据
(function() {
    var service = {
        getList: function(params, callback) {
            ajax.request({
                url: 'treeview.json',
                method: 'get',
                type: 'json',
                success: function(data) {
                    callback && callback(data);
                }
            });
        }
    };

    var treeView = new TreeView({
        service: service
    }).$inject('#j-example3');
})();

// 分级加载
(function() {
    var service = {
        getList: function(params, callback) {
            ajax.request({
                url: 'treeview2.json',
                method: 'get',
                type: 'json',
                success: function(data) {
                    callback && callback(data);
                }
            });
        }
    };

    var treeView = new TreeView({
        service: service,
        data: {
            hierarchical: true
        }
    }).$inject('#j-example4');
})();

// 自定义选择项
(function() {
    var itemTemplate = _.multiline(function(){/*    
    <i class="u-icon {item.type === 'directory' ? (item.open ? 'u-icon-folder-open' : 'u-icon-folder') : 'u-icon-file-text'}"></i> {item.name}
    */});

    var service = {
        getList: function(params, callback) {
            ajax.request({
                url: 'treeview2.json',
                method: 'get',
                type: 'json',
                success: function(data) {
                    callback && callback(data);
                }
            });
        }
    };
    var treeView = new TreeView({
        service: service,
        data: {
            hierarchical: true,
            itemTemplate: itemTemplate
        }
    }).$inject('#j-example5');
})();


// 拖拽
(function() {
    var win = window;
    // 获得盒子的的boundingRect
   function getRect(elem) {
       var docElem, body, win, clientTop, clientLeft, scrollTop, scrollLeft,
           box = {
               top: 0,
               left: 0
           },
           doc = elem && elem.ownerDocument,
           win = window,
           body = doc.body;

       if (!doc) return;
       docElem = doc.documentElement;

       if (typeof elem.getBoundingClientRect !== "undefined") {
           box = elem.getBoundingClientRect();
       }

       clientTop = docElem.clientTop || body.clientTop || 0;
       clientLeft = docElem.clientLeft || body.clientLeft || 0;
       scrollTop = win.pageYOffset || docElem.scrollTop;
       scrollLeft = win.pageXOffset || docElem.scrollLeft;

       return {
           top: box.top + scrollTop - clientTop,
           left: box.left + scrollLeft - clientLeft
       };
   }

    var dom = Regular.dom;

    function start(ev) {
        // delay
        if(ev.which === 3) return;
        tid = setTimeout(function function_name(argument) {
            dom.on(document, 'mousemove', move);
            dom.on(document, 'mouseup', end);
            fire({
                type: 'dragstart',
                target: elem,
                pageX: ev.pageX,
                pageY: ev.pageY
            });
        }, 200)
        dom.on(document, 'mousemove', stopDocument)
    }
    function DragModule(Component){
        Component.implement({
        })

        Component.directive({
            'dragarea': function(elem, value){
                var dragItems = this._dragItems;

                function dragMove(ev){
                    if(!this.dragInfo) return;
                    var dragInfo = this.dragInfo;
                    if (win.getSelection) {
                       win.getSelection().removeAllRanges();
                    } else if (win.document.selection) {
                       win.document.selection.empty();
                    }
                    var targetX = ev.pageX - document.body.scrollLeft;
                    var targetY = ev.pageY - (win.pageYOffset || document.documentElement.scrollTop);

                    dragInfo.container.style.left = ev.pageX - dragInfo.start.pageX + dragInfo.start.left + 'px';
                    dragInfo.container.style.top = ev.pageY - dragInfo.start.pageY + dragInfo.start.top + 'px';

                    var target = document.elementFromPoint(targetX, targetY);
                    if(target.className.indexOf('treeview_itemname') === -1 ) return;


                    var targetOffset = getRect(target);
                    var breakPoint = target.offsetHeight/3;
                    if(ev.pageY - targetOffset.top < breakPoint){ // 上
                        var swap = target.parentNode.parentNode;
                        dom.inject(dragInfo.placeholder, swap, 'before')
                        dragInfo.swap = {
                            key: swap.key,
                            'position': 'before'
                        }
                    }else if(targetOffset.top + target.offsetHeight - ev.pageY < breakPoint){
                        var swap = target.parentNode.parentNode;
                        dom.inject(dragInfo.placeholder, swap, 'after')
                        dragInfo.swap = {
                            key: swap.key,
                            'position': 'after'
                        }
                    }else{ // 在中间位置
                        var swap = target.parentNode.parentNode;
                        // @TODO: 当在节点上时 ， 我们怎么做？
                        dragInfo.swap = {
                            key: swap.key,
                            'position': 'bottom'
                        }
                    }
                }

                function dragEnd(){
                    if(this.dragInfo){
                        var dragInfo = this.dragInfo;
                        var container = dragInfo.container;
                        dom.delClass( container, 'z-drag');
                        dom.remove(dragInfo.placeholder);
                        dom.inject(container, dragInfo.elem);

                        dragInfo.elem.style.display=''
                        dragInfo.container.style.cssText=''
                        this.$emit('dragend', {
                            key: dragInfo.elem.key,
                            swap: dragInfo.swap
                        });
                    }
                    this.dragInfo = null;
                }

                dom.on(document.body, 'mousemove', dragMove.bind(this))
                dom.on(document.body, 'mouseup', dragEnd.bind(this))
            },
            'dragitem': function(elem, value){
                elem.key = this.$get(value);// 获得传入的标示符
                var tagName = elem.tagName.toLowerCase();
                var tid, self = this;

                var dragInfo = {
                    elem: elem,
                    start: {},
                    container: elem.getElementsByTagName('div')[0],
                    placeholder: null
                }
                // 当真的触发时
                function realStart(ev){
                    if(ev.which === 3) return;
                   var container = dragInfo.container
                   var width = elem.offsetWidth;
                   var height = elem.offsetHeight; 
                   dragInfo.start.pageX = ev.pageX;
                   dragInfo.start.pageY = ev.pageY;

                   self.dragInfo = dragInfo

                   var rect = getRect(elem);

                   dragInfo.start.left = rect.left;
                   dragInfo.start.top = rect.top;

                   dom.inject(container, document.body);
                   elem.style.display = 'none';

                   this.treeroot.dragInfo = dragInfo;
                   // this.$emit('dragitem', dragInfo);

                   dom.addClass(container, 'z-drag')
                   container.style.position = 'absolute';
                   container.style.top = rect.top +'px';
                   container.style.left = rect.left +'px';
                   container.style.opacity = '0.8';
                   container.style.width = width + 'px';
                   var placeholder = /*dragInfo.placeholder ||*/ ( dragInfo.placeholder = document.createElement(tagName) );
                   placeholder.className = 'u-tplaceholder';
                   placeholder.style.width = width + 'px';
                   placeholder.style.height = height + 'px';
                   dom.inject(placeholder, elem, 'after' );
                }
                function start(ev){
                    tid = setTimeout(function(){
                       realStart.call(self, ev)    
                    } ,200) 
                    ev.stopPropagation();
                }
                function cancel(ev){

                    clearTimeout(tid);
                }

                dom.on( elem, 'mousedown', start )
                dom.on( elem, 'mouseup', cancel )
            }
        })
    }

    var source = [
        {id: 1, name: '节点1', children: [
            {id: 11, name: '节点1.1'},
            {id: 12, name: '节点1.2', children: [
                {id: 101, name: '节点1.2.1'},
                {id: 101, name: '节点1.2.1'},
                {id: 101, name: '节点1.2.1'},
                {id: 102, name: '节点1.2.2'}
            ]},
            {id: 13, name: '节点1.3'},
            {id: 14, name: '节点1.4'},
        ]},
        {id: 2, name: '节点2'},
        {id: 3, name: '节点3', children: [
            {id: 15, name: '节点3.1'},
            {id: 16, name: '节点3.2'}
        ]},
        {id: 4, name: '节点4'},
        {id: 5, name: '节点5'},
        {id: 6, name: '节点6'}
    ];


    var template = _.multiline(function(){/*
<ul class="treeview_list" r-class={ {'z-dis': disabled} } r-hide={!visible}>
    {#list source as item}
    <li>
        <div class="treeview_item">
            {#if item.childrenCount || (item.children && item.children.length)}
            <i class="u-icon" r-class={ {'u-icon-caret-right': !item.open, 'u-icon-caret-down': item.open}} on-click={this.toggle(item)}></i>
            {/if}
            <div class="treeview_itemname" r-class={ {'z-sel': this.treeroot.data.selected === item} } on-click={this.select(item)}>{#if @(itemTemplate)}{#include @(itemTemplate)}{#else}{item.name}{/if}</div>
        </div>
        {#if item.childrenCount || (item.children && item.children.length)}<treeViewList source={item.children} visible={item.open} parent={item} />{/if}
    </li>
    {/list}
</ul>
    */})


    Regular.use(DragModule);

    var drag = new TreeView({
        data: {
            source: source
        },
        events: {
            dragend: function(info){
                this.insert(info.key, info.swap.key, info.swap.position)
                this.$update();

            }
        },
        insert: function(item1, item2, position){

            if(item1 === item2) return;
            var old = this.findListAndPosition(this.data.source, item1);
            // 我们先将index 排除
            old.list.splice(old.index,1)
            var point = this.findListAndPosition(this.data.source,item2)
            if(!point) return;
            if(position === 'before'){
                point.list.splice(point.index, 0, item1)
            }else if(position === 'after'){
                point.list.splice(point.index+1, 0, item1)
                // console.log(JSON.stringify(point.list))
            }else{ // 说明是bottom
                if(item2.children){
                    item2.children.push(item1);
                }
            }
        },
        findListAndPosition: function(list, item){
            if(!list || !list.length) return ;
            var len = list.length, result;
            for(;len--;){
                var test = list[len];
                if(item == test) return {list: list, index: len}
                else if(test.children && test.children.length){
                    result = this.findListAndPosition(test.children, item);
                    if(result) return result;
                }
            }
        }
    }).$inject("#j-example6")

})();



</script>
</body>
</html>